<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: storage-wallet.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: storage-wallet.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import DockWallet from './dock-wallet';

/** The Dock Wallet which loads, adds, removes and queries contents in an EDV */
class StorageWallet extends DockWallet {
  constructor(id, storageInterface) {
    super(id);

    this.promises = [];
    this.storageInterface = storageInterface;
  }

  add(content) {
    super.add(content);
    this.promises.push(this.insertToStorage(content));
  }

  remove(contentId) {
    super.remove(contentId);
    this.promises.push(this.removeFromStorage(contentId));
  }

  update(content) {
    super.update(content);
    this.promises.push(this.updateInStorage(content));
  }

  async query(search) {
    // tODO: query the in memory contents first and pass flag to not use it, if empty run storage search
    // Query storage interface and map into wallet contents
    const { documents } = await this.storageInterface.find(search);
    return documents.map((document) => document.content);
  }

  async load() {
    // Find all documents, storage interfaces should return all docs when no params supplied
    const { documents } = await this.storageInterface.find();

    // Format to wallet contents
    if (documents) {
      documents.forEach((document) => super.add(document.content));
    }
    return this.contents;
  }

  async updateInStorage(content) {
    const documentResult = await this.getStorageDocument(content);
    await this.storageInterface.update({
      document: {
        ...documentResult,
        content,
      },
    });
  }

  async insertToStorage(content) {
    // Attempt to insert the document to the storage interface
    // if the promise fails, then the content will be removed and error re-thrown
    try {
      await this.storageInterface.insert({
        document: {
          content,
        },
      });
    } catch (e) {
      super.remove(content.id);
      throw e;
    }
  }

  async removeFromStorage(id) {
    await this.storageInterface.delete({
      document: await this.getStorageDocument({ id }),
    });
  }

  async getStorageDocument({ id }) {
    // Find the storage document by the content ID
    // some interfaces may just return the same document, but some need custom structures
    const { documents } = await this.storageInterface.find({
      equals: {
        'content.id': id,
      },
    });

    // Delete first result from storage
    if (documents.length) {
      return documents[0];
    } else {
      throw new Error(`Unable to find storage document by content.id: ${id}`);
    }
  }

  async sync() {
    // A user will call this method to ensure storage interface requests finish
    // we do this because wallet doesnt always require blocking operations
    // depending on the storage interface used
    const { promises } = this;
    this.promises = [];
    if (promises.length) {
      await Promise.all(promises);
    }
  }
}

export default StorageWallet;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DockWallet.html">DockWallet</a></li><li><a href="EDVHTTPStorageInterface.html">EDVHTTPStorageInterface</a></li><li><a href="FSStorageInterface.html">FSStorageInterface</a></li><li><a href="StorageInterface.html">StorageInterface</a></li><li><a href="StorageWallet.html">StorageWallet</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Tue Feb 14 2023 00:12:24 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
